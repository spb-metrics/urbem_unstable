/*
    **********************************************************************************
    *                                                                                *
    * @package URBEM CNM - Soluções em Gestão Pública                                *
    * @copyright (c) 2013 Confederação Nacional de Municípos                         *
    * @author Confederação Nacional de Municípios                                    *
    *                                                                                *
    * O URBEM CNM é um software livre; você pode redistribuí-lo e/ou modificá-lo sob *
    * os  termos  da Licença Pública Geral GNU conforme  publicada  pela Fundação do *
    * Software Livre (FSF - Free Software Foundation); na versão 2 da Licença.       *
    *                                                                                *
    * Este  programa  é  distribuído  na  expectativa  de  que  seja  útil,   porém, *
    * SEM NENHUMA GARANTIA; nem mesmo a garantia implícita  de  COMERCIABILIDADE  OU *
    * ADEQUAÇÃO A UMA FINALIDADE ESPECÍFICA. Consulte a Licença Pública Geral do GNU *
    * para mais detalhes.                                                            *
    *                                                                                *
    * Você deve ter recebido uma cópia da Licença Pública Geral do GNU "LICENCA.txt" *
    * com  este  programa; se não, escreva para  a  Free  Software Foundation  Inc., *
    * no endereço 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.       *
    *                                                                                *
    **********************************************************************************
*/
CREATE OR REPLACE FUNCTION tcers.busca_regime(stEntidade varchar, contrato integer) RETURNS varchar as $$
DECLARE
  stDesc VARCHAR;
  stSql  VARCHAR;

BEGIN
	
  stSql := '  SELECT 
                      regime_previdencia.descricao 
                  FROM pessoal'|| stEntidade ||'.contrato_servidor_previdencia
            INNER JOIN ( SELECT cod_contrato
                               , max(timestamp) as timestamp
                           FROM pessoal'|| stEntidade ||'.contrato_servidor_previdencia
                       GROUP BY cod_contrato) as max_contrato_servidor_previdencia
                    ON contrato_servidor_previdencia.cod_contrato = max_contrato_servidor_previdencia.cod_contrato
                   AND contrato_servidor_previdencia.timestamp = max_contrato_servidor_previdencia.timestamp
            INNER JOIN folhapagamento'|| stEntidade ||'.previdencia
                    ON contrato_servidor_previdencia.cod_previdencia = previdencia.cod_previdencia
            INNER JOIN folhapagamento'|| stEntidade ||'.regime_previdencia
                    ON previdencia.cod_regime_previdencia = regime_previdencia.cod_regime_previdencia
		WHERE contrato_servidor_previdencia.cod_contrato = '|| contrato ||'; ';

  stDesc := selectIntoVarChar(stSql);

RETURN stDesc;

end;
$$LANGUAGE plpgsql;


CREATE OR REPLACE FUNCTION tcers.recuperarCadastroFuncionarios ( stEntidade VARCHAR, dtInicial VARCHAR, dtFinal VARCHAR ) RETURNS SETOF RECORD AS $$
DECLARE
  stSql      VARCHAR;
  reRegistro RECORD;
BEGIN

stSql := '(
              (SELECT to_char(max_timestamp_periodo_movimentacao.dt_inicial,''dd/mm/yyyy'') as dt_inicial
                , sw_cgm.nom_cgm as nome
                , to_char(dt_nascimento, ''dd/mm/yyyy'') as dt_nascimento
                , sw_cgm_pessoa_fisica.cpf as cpf
                , sw_cgm_pessoa_fisica.servidor_pis_pasep
                , sw_cgm_pessoa_fisica.rg
                , (CASE WHEN sw_cgm_pessoa_fisica.sexo = ''m'' THEN 1
                        ELSE 2
                  END) as sexo 
                , contrato.registro as cod_registro_funcionario
                , to_char(contrato_servidor_nomeacao_posse.dt_admissao,''dd/mm/yyyy'') as dt_admissao
                , CASE WHEN to_char(contrato_servidor_caso_causa.dt_rescisao,''dd/mm/yyyy'') is null THEN ''00000000''
                        ELSE to_char(contrato_servidor_caso_causa.dt_rescisao,''dd/mm/yyyy'')
                  END as dt_rescisao 
                , recuperaDescricaoOrgao(orgao.cod_orgao, '|| quote_literal(dtFinal) ||') as Setor
                , orgao.cod_orgao as cod_setor
                , cargo.cod_cargo
                , cargo.descricao as cargo
                , (SELECT codigo FROM pessoal'|| stEntidade ||'.cbo WHERE cbo_cargo.cod_cbo = cbo.cod_cbo) as cbo
                , (SELECT descricao FROM pessoal'|| stEntidade ||'.regime WHERE cod_regime = contrato_servidor.cod_regime)||''-''||(SELECT descricao FROM pessoal'|| stEntidade ||'.sub_divisao WHERE cod_sub_divisao = contrato_servidor.cod_sub_divisao) as natureza_cargo                
                
                , (SELECT count(*) FROM pessoal'|| stEntidade ||'.dependente WHERE dependente.numcgm = sw_cgm.numcgm AND cod_vinculo != 0)::integer as qtd_dependentes_irrf
        
                , (CASE WHEN recuperarSituacaoDoContratoLiteral(contrato.cod_contrato::integer,max_timestamp_periodo_movimentacao.cod_periodo_movimentacao,  '|| quote_literal(stEntidade) ||')::varchar = ''Ativo'' THEN ''01''
                        WHEN recuperarSituacaoDoContratoLiteral(contrato.cod_contrato::integer, max_timestamp_periodo_movimentacao.cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||')::varchar = ''Aposentado'' THEN ''02''
                        WHEN recuperarSituacaoDoContratoLiteral(contrato.cod_contrato::integer, max_timestamp_periodo_movimentacao.cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||')::varchar = ''Pensionista'' THEN ''03''
                        ELSE ''99''
                   END)::varchar as situacao

                , ( CASE WHEN (SELECT CASE WHEN folhapagamento'|| stEntidade ||'.previdencia.cod_regime_previdencia = 1 THEN ''02''
                                           WHEN folhapagamento'|| stEntidade ||'.previdencia.cod_regime_previdencia = 2 THEN ''01''
                                           ELSE ''02''
                                      END
            
                                        FROM folhapagamento'|| stEntidade ||'.previdencia
                        
                                        INNER JOIN pessoal'|| stEntidade ||'.contrato_servidor_previdencia ON folhapagamento'|| stEntidade ||'.previdencia.cod_previdencia = pessoal'|| stEntidade ||'.contrato_servidor_previdencia.cod_previdencia
                                                        AND pessoal'|| stEntidade ||'.contrato_servidor_previdencia.bo_excluido = false
                                                        AND timestamp = (SELECT max(max_timestamp.timestamp)
                                                                         FROM pessoal'|| stEntidade ||'.contrato_servidor_previdencia AS max_timestamp
                                                                         INNER JOIN ( SELECT dt_inicial,
                                                                                             timestampfechamentoperiodomovimentacao(cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||') as timestamp_fechamento_periodo
                                                                                      FROM folhapagamento'|| stEntidade ||'.periodo_movimentacao
                                                                                    ) AS max_timestamp_periodo_movimentacao
                                        ON max_timestamp_periodo_movimentacao.dt_inicial BETWEEN '|| quote_literal(dtInicial) ||' AND '|| quote_literal(dtFinal) ||'
                                                 WHERE pessoal'|| stEntidade ||'.contrato_servidor_previdencia.cod_contrato = max_timestamp.cod_contrato
                                                   AND max_timestamp.timestamp::VARCHAR <= max_timestamp_periodo_movimentacao.timestamp_fechamento_periodo)
                                                   AND pessoal'|| stEntidade ||'.contrato_servidor_previdencia.cod_contrato = pessoal'|| stEntidade ||'.contrato_servidor.cod_contrato
                                              GROUP BY pessoal'|| stEntidade ||'.contrato_servidor_previdencia.cod_contrato,
                                                       pessoal'|| stEntidade ||'.contrato_servidor_previdencia.cod_previdencia,
                                                       folhapagamento'|| stEntidade ||'.previdencia.cod_regime_previdencia
                    ) IS NULL THEN 
                          ''APOSENT.PENS. FUNDO PREVID.''
                    ELSE
                           CASE WHEN recuperarSituacaoDoContratoLiteral(contrato.cod_contrato::integer, max_timestamp_periodo_movimentacao.cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||')::varchar <> ''Ativo''       AND
                                recuperarSituacaoDoContratoLiteral(contrato.cod_contrato::integer, max_timestamp_periodo_movimentacao.cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||')::varchar <> ''Aposentado''  AND
                                recuperarSituacaoDoContratoLiteral(contrato.cod_contrato::integer, max_timestamp_periodo_movimentacao.cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||')::varchar <> ''Pensionista'' THEN
                                recuperarSituacaoDoContratoLiteral(contrato.cod_contrato::integer, max_timestamp_periodo_movimentacao.cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||')
                           END
                    END)::varchar AS observacoes        
        
                , (CASE WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_regime = 1 THEN ''C''
                        WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_regime = 2 THEN ''E''
                        ELSE ''O''
                   END)::varchar as cod_regime
        
                , (CASE WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_sub_divisao = 1 THEN ''E''
                        WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_sub_divisao = 2 THEN ''E''
                        WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_sub_divisao = 3 THEN ''T''
                        WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_sub_divisao = 4 THEN ''E''
                        WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_sub_divisao = 5 THEN ''T''
                        WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_sub_divisao = 6 THEN ''C''
                        WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_sub_divisao = 7 THEN ''E''
                        WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_sub_divisao = 8 THEN ''T''
                        ELSE ''O''
                   END)::varchar as cod_sub_divisao 
        
                , CASE WHEN (SELECT CASE WHEN folhapagamento'|| stEntidade ||'.previdencia.cod_regime_previdencia = 1 THEN ''02''
                                         WHEN folhapagamento'|| stEntidade ||'.previdencia.cod_regime_previdencia = 2 THEN ''01''
                                         ELSE ''02''
                                    END 
                  
                          FROM folhapagamento'|| stEntidade ||'.previdencia
                  
                          INNER JOIN pessoal'|| stEntidade ||'.contrato_servidor_previdencia ON folhapagamento'|| stEntidade ||'.previdencia.cod_previdencia = pessoal'|| stEntidade ||'.contrato_servidor_previdencia.cod_previdencia
                                          AND pessoal'|| stEntidade ||'.contrato_servidor_previdencia.bo_excluido = false
                                          AND timestamp = (SELECT max(max_timestamp.timestamp)
                                                           FROM pessoal'|| stEntidade ||'.contrato_servidor_previdencia AS max_timestamp
                                                           INNER JOIN ( SELECT dt_inicial,
                                                                               timestampfechamentoperiodomovimentacao(cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||') as timestamp_fechamento_periodo
                                                                        FROM folhapagamento'|| stEntidade ||'.periodo_movimentacao 
                                                                      ) AS max_timestamp_periodo_movimentacao
                          ON max_timestamp_periodo_movimentacao.dt_inicial BETWEEN '|| quote_literal(dtInicial) ||' AND '|| quote_literal(dtFinal) ||'
                                   WHERE pessoal'|| stEntidade ||'.contrato_servidor_previdencia.cod_contrato = max_timestamp.cod_contrato
                                     AND max_timestamp.timestamp::VARCHAR <= max_timestamp_periodo_movimentacao.timestamp_fechamento_periodo)
                                     AND pessoal'|| stEntidade ||'.contrato_servidor_previdencia.cod_contrato = pessoal'|| stEntidade ||'.contrato_servidor.cod_contrato
                                GROUP BY pessoal'|| stEntidade ||'.contrato_servidor_previdencia.cod_contrato, 
                                         pessoal'|| stEntidade ||'.contrato_servidor_previdencia.cod_previdencia,
                                         folhapagamento'|| stEntidade ||'.previdencia.cod_regime_previdencia
                  ) IS NULL THEN
                        ''99''
                  ELSE
                          (SELECT CASE WHEN folhapagamento'|| stEntidade ||'.previdencia.cod_regime_previdencia = 1 THEN ''02''
                                       WHEN folhapagamento'|| stEntidade ||'.previdencia.cod_regime_previdencia = 2 THEN ''01''
                                       ELSE ''02''
                                  END
        
                        FROM folhapagamento'|| stEntidade ||'.previdencia
        
                        INNER JOIN pessoal'|| stEntidade ||'.contrato_servidor_previdencia ON folhapagamento'|| stEntidade ||'.previdencia.cod_previdencia = pessoal'|| stEntidade ||'.contrato_servidor_previdencia.cod_previdencia
                                        AND pessoal'|| stEntidade ||'.contrato_servidor_previdencia.bo_excluido = false
                                        AND timestamp = (SELECT max(max_timestamp.timestamp)
                                                         FROM pessoal'|| stEntidade ||'.contrato_servidor_previdencia AS max_timestamp
                                                         INNER JOIN ( SELECT dt_inicial,
                                                                             timestampfechamentoperiodomovimentacao(cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||') as timestamp_fechamento_periodo
                                                                      FROM folhapagamento'|| stEntidade ||'.periodo_movimentacao
                                                                    ) AS max_timestamp_periodo_movimentacao
                        ON max_timestamp_periodo_movimentacao.dt_inicial BETWEEN '|| quote_literal(dtInicial) ||' AND '|| quote_literal(dtFinal) ||'
                                 WHERE pessoal'|| stEntidade ||'.contrato_servidor_previdencia.cod_contrato = max_timestamp.cod_contrato
                                   AND max_timestamp.timestamp::VARCHAR <= max_timestamp_periodo_movimentacao.timestamp_fechamento_periodo)
                                   AND pessoal'|| stEntidade ||'.contrato_servidor_previdencia.cod_contrato = pessoal'|| stEntidade ||'.contrato_servidor.cod_contrato
                              GROUP BY pessoal'|| stEntidade ||'.contrato_servidor_previdencia.cod_contrato,
                                       pessoal'|| stEntidade ||'.contrato_servidor_previdencia.cod_previdencia,
                                       folhapagamento'|| stEntidade ||'.previdencia.cod_regime_previdencia)      
                  END::varchar AS cod_regime_previdencia

                , pessoal'|| stEntidade ||'.contrato_servidor.cod_categoria as cod_categoria
                , (sw_cgm.logradouro||'',''||sw_cgm.numero|| '' - '' ||sw_cgm.complemento)::varchar as endereco
                , (SELECT UPPER(nom_municipio) as nom_municipio FROM sw_municipio WHERE cod_municipio = sw_cgm.cod_municipio and cod_uf = sw_cgm.cod_uf )::varchar as cidade
                , (SELECT sigla_uf FROM sw_uf WHERE sw_uf.cod_uf = sw_cgm.cod_uf)::varchar as uf
                , sw_cgm.cep
        
                FROM pessoal'|| stEntidade ||'.servidor

                INNER JOIN sw_cgm
                        ON servidor.numcgm = sw_cgm.numcgm
        
                INNER JOIN sw_cgm_pessoa_fisica
                        ON sw_cgm.numcgm = sw_cgm_pessoa_fisica.numcgm
        
                INNER JOIN pessoal'|| stEntidade ||'.servidor_contrato_servidor
                        ON servidor.cod_servidor = servidor_contrato_servidor.cod_servidor
        
                INNER JOIN pessoal'|| stEntidade ||'.contrato_servidor
                        ON servidor_contrato_servidor.cod_contrato = contrato_servidor.cod_contrato
        
                INNER JOIN pessoal'|| stEntidade ||'.contrato
                        ON servidor_contrato_servidor.cod_contrato = contrato.cod_contrato
        
                INNER JOIN ( SELECT cod_periodo_movimentacao, dt_inicial, dt_final, timestampfechamentoperiodomovimentacao(cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||') as timestamp_fechamento_periodo
                              FROM folhapagamento'|| stEntidade ||'.periodo_movimentacao 
                           ) AS max_timestamp_periodo_movimentacao
                       ON max_timestamp_periodo_movimentacao.dt_inicial BETWEEN '|| quote_literal(dtInicial) ||' AND '|| quote_literal(dtFinal) ||'
        
                INNER JOIN pessoal'|| stEntidade ||'.contrato_servidor_nomeacao_posse
                        ON contrato.cod_contrato = contrato_servidor_nomeacao_posse.cod_contrato
        
                INNER JOIN ( SELECT cod_contrato, max(timestamp) as timestamp 
                               FROM pessoal'|| stEntidade ||'.contrato_servidor_nomeacao_posse
                         INNER JOIN ( SELECT dt_inicial,
                                             timestampfechamentoperiodomovimentacao(cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||') as timestamp_fechamento_periodo
                                        FROM folhapagamento'|| stEntidade ||'.periodo_movimentacao 
                                    ) AS max_timestamp_periodo_movimentacao
                                ON max_timestamp_periodo_movimentacao.dt_inicial BETWEEN '|| quote_literal(dtInicial) ||' AND '|| quote_literal(dtFinal) ||'
                             WHERE contrato_servidor_nomeacao_posse.timestamp::VARCHAR <= max_timestamp_periodo_movimentacao.timestamp_fechamento_periodo
                          GROUP BY cod_contrato) as max_contrato_servidor_nomeacao_posse
                        ON contrato_servidor_nomeacao_posse.cod_contrato = max_contrato_servidor_nomeacao_posse.cod_contrato
                       AND contrato_servidor_nomeacao_posse.timestamp = max_contrato_servidor_nomeacao_posse.timestamp
        
                INNER JOIN pessoal'|| stEntidade ||'.cargo
                        ON contrato_servidor.cod_cargo = cargo.cod_cargo
        
                INNER JOIN pessoal'|| stEntidade ||'.cbo_cargo
                        ON cargo.cod_cargo = cbo_cargo.cod_cargo
        
                INNER JOIN ( SELECT cod_cargo, max(timestamp) as timestamp 
                              FROM pessoal'|| stEntidade ||'.cbo_cargo
                        INNER JOIN ( SELECT dt_inicial,
                                            timestampfechamentoperiodomovimentacao(cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||') as timestamp_fechamento_periodo
                                       FROM folhapagamento'|| stEntidade ||'.periodo_movimentacao 
                                   ) AS max_timestamp_periodo_movimentacao
                                ON max_timestamp_periodo_movimentacao.dt_inicial BETWEEN '|| quote_literal(dtInicial) ||' AND '|| quote_literal(dtFinal) ||'
                             WHERE cbo_cargo.timestamp::VARCHAR <= max_timestamp_periodo_movimentacao.timestamp_fechamento_periodo 
                          GROUP BY cod_cargo) as max_cbo_cargo 
                        ON cbo_cargo.cod_cargo = max_cbo_cargo.cod_cargo
                       AND cbo_cargo.timestamp = max_cbo_cargo.timestamp
        
                INNER JOIN pessoal'|| stEntidade ||'.contrato_servidor_orgao
                        ON contrato.cod_contrato = contrato_servidor_orgao.cod_contrato
        
                INNER JOIN ( SELECT cod_contrato, max(timestamp) as timestamp 
                               FROM pessoal'|| stEntidade ||'.contrato_servidor_orgao
                         INNER JOIN ( SELECT dt_inicial,
                                             timestampfechamentoperiodomovimentacao(cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||') as timestamp_fechamento_periodo
                                        FROM folhapagamento'|| stEntidade ||'.periodo_movimentacao 
                                    ) AS max_timestamp_periodo_movimentacao
                                 ON max_timestamp_periodo_movimentacao.dt_inicial BETWEEN '|| quote_literal(dtInicial) ||' AND '|| quote_literal(dtFinal) ||'
                              WHERE contrato_servidor_orgao.timestamp::VARCHAR <= max_timestamp_periodo_movimentacao.timestamp_fechamento_periodo
                           GROUP BY cod_contrato) as max_contrato_servidor_orgao 
                        ON contrato_servidor_orgao.cod_contrato = max_contrato_servidor_orgao.cod_contrato
                       AND contrato_servidor_orgao.timestamp = max_contrato_servidor_orgao.timestamp
        
                INNER JOIN organograma.orgao
                        ON contrato_servidor_orgao.cod_orgao = orgao.cod_orgao
                
                LEFT JOIN (  SELECT cod_contrato, cod_previdencia, max(timestamp) as timestamp 
                               FROM pessoal'|| stEntidade ||'.contrato_servidor_previdencia
                               INNER JOIN ( SELECT dt_inicial,
                                                   timestampfechamentoperiodomovimentacao(cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||') as timestamp_fechamento_periodo
                                              FROM folhapagamento'|| stEntidade ||'.periodo_movimentacao 
                                          ) AS max_timestamp_periodo_movimentacao
                                       ON max_timestamp_periodo_movimentacao.dt_inicial BETWEEN '|| quote_literal(dtInicial) ||' AND '|| quote_literal(dtFinal) ||'
                              WHERE contrato_servidor_previdencia.timestamp::VARCHAR <= max_timestamp_periodo_movimentacao.timestamp_fechamento_periodo
                              GROUP BY cod_contrato, cod_previdencia) as contrato_servidor_previdencia 
                      ON contrato.cod_contrato = contrato_servidor_previdencia.cod_contrato	        
        
                LEFT JOIN pessoal'|| stEntidade ||'.contrato_servidor_caso_causa
                       ON servidor_contrato_servidor.cod_contrato = contrato_servidor_caso_causa.cod_contrato
                )
  UNION
				(SELECT to_char(max_timestamp_periodo_movimentacao.dt_inicial,''dd/mm/yyyy'') as dt_inicial
					   ,nom_cgm as nome
					   ,to_char(dt_nascimento, ''dd/mm/yyyy'') as dt_nascimento
					   ,cpf
					   ,servidor_pis_pasep 
					   ,rg
					   ,(CASE WHEN sw_cgm_pessoa_fisica.sexo = ''m'' THEN 1
							ELSE 2
						END ) as sexo
					   ,contrato.registro as cod_registro_funcionario
					   ,to_char(dt_inicio_beneficio,''dd/mm/yyyy'') as dt_admissao
					   ,(CASE WHEN to_char(dt_encerramento,''dd/mm/yyyy'') is null THEN ''00000000''
					          ELSE to_char(dt_encerramento,''dd/mm/yyyy'')
					     END)as dt_rescisao
					   ,recuperaDescricaoOrgao(orgao.cod_orgao, '|| quote_literal(dtFinal) ||') as Setor
					   ,orgao.cod_orgao as cod_setor
					   ,cargo.cod_cargo
					   ,cargo.descricao as cargo
					   ,(SELECT codigo FROM pessoal'|| stEntidade ||'.cbo WHERE cbo_cargo.cod_cbo = cbo.cod_cbo) as cbo
					   ,(SELECT descricao 
						   FROM pessoal'|| stEntidade ||'.regime 
						   WHERE cod_regime = contrato_servidor.cod_regime)||''-''||(SELECT descricao 
																					 FROM pessoal'|| stEntidade ||'.sub_divisao 
																					WHERE cod_sub_divisao = contrato_servidor.cod_sub_divisao) as natureza_cargo                
					   ,(SELECT count(servidor_dependente.cod_dependente) 
						   FROM pessoal'|| stEntidade ||'.servidor_dependente, pessoal'|| stEntidade ||'.dependente 
						  WHERE cod_servidor= servidor_contrato_servidor.cod_servidor
							AND servidor_dependente.cod_dependente=dependente.cod_dependente 
							AND dependente.cod_vinculo > 0
							AND servidor_dependente.cod_dependente not in (SELECT cod_dependente FROM pessoal'|| stEntidade ||'.dependente_excluido))::integer as qtd_dependentes_irrf
					   ,(CASE WHEN recuperarSituacaoDoContratoLiteral(contrato.cod_contrato::integer,max_timestamp_periodo_movimentacao.cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||')::varchar = ''Ativo'' THEN ''01''
							  WHEN recuperarSituacaoDoContratoLiteral(contrato.cod_contrato::integer, max_timestamp_periodo_movimentacao.cod_periodo_movimentacao,'|| quote_literal(stEntidade) ||')::varchar = ''Aposentado'' THEN ''02''
							  WHEN recuperarSituacaoDoContratoLiteral(contrato.cod_contrato::integer, max_timestamp_periodo_movimentacao.cod_periodo_movimentacao,'|| quote_literal(stEntidade) ||')::varchar = ''Pensionista'' THEN ''03''
						 ELSE ''99''
						END)::varchar as situacao
						, ''PENSIONISTA FUNDO PREVID.''::varchar  AS observacoes         
						, (CASE WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_regime = 1 THEN ''C''
								WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_regime = 2 THEN ''E''
								ELSE ''O''
						   END)::varchar as cod_regime
						,(CASE WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_sub_divisao = 1 THEN ''E''
							   WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_sub_divisao = 2 THEN ''E''
							   WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_sub_divisao = 3 THEN ''T''
							   WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_sub_divisao = 4 THEN ''E''
							   WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_sub_divisao = 5 THEN ''T''
							   WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_sub_divisao = 6 THEN ''C''
							   WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_sub_divisao = 7 THEN ''E''
							   WHEN pessoal'|| stEntidade ||'.contrato_servidor.cod_sub_divisao = 8 THEN ''T''
							   ELSE ''O''
						   END)::varchar as cod_sub_divisao 
						,COALESCE((SELECT (CASE WHEN previdencia.cod_regime_previdencia = 1 THEN ''02''
												WHEN previdencia.cod_regime_previdencia = 2 THEN ''01''
												ELSE ''99''
										   END)
									 FROM folhapagamento'|| stEntidade ||'.previdencia 
									WHERE previdencia.cod_regime_previdencia = contrato_pensionista_previdencia.cod_previdencia
								  ),''99'') as cod_regime_previdencia
						, pessoal'|| stEntidade ||'.contrato_servidor.cod_categoria as cod_categoria
						, (sw_cgm.logradouro||'',''||sw_cgm.numero|| '' - '' ||sw_cgm.complemento)::varchar as endereco
						, (SELECT UPPER(nom_municipio) as nom_municipio FROM sw_municipio WHERE cod_municipio = sw_cgm.cod_municipio and cod_uf = sw_cgm.cod_uf )::varchar as cidade
						, (SELECT sigla_uf FROM sw_uf WHERE sw_uf.cod_uf = sw_cgm.cod_uf)::varchar as uf
						, sw_cgm.cep
				FROM sw_cgm

				INNER JOIN sw_cgm_pessoa_fisica
						ON sw_cgm.numcgm = sw_cgm_pessoa_fisica.numcgm

				INNER JOIN pessoal'|| stEntidade ||'.pensionista
						ON pensionista.numcgm = sw_cgm.numcgm

				INNER JOIN pessoal'|| stEntidade ||'.contrato_pensionista
						ON contrato_pensionista.cod_pensionista=pensionista.cod_pensionista
					   AND contrato_pensionista.cod_contrato_cedente = pensionista.cod_contrato_cedente

				INNER JOIN pessoal'|| stEntidade ||'.contrato 
						ON contrato.cod_contrato = contrato_pensionista.cod_contrato

				INNER JOIN ( SELECT cod_periodo_movimentacao, dt_inicial, dt_final, timestampfechamentoperiodomovimentacao(cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||') as timestamp_fechamento_periodo
							   FROM folhapagamento'|| stEntidade ||'.periodo_movimentacao 
						   ) AS max_timestamp_periodo_movimentacao
						ON max_timestamp_periodo_movimentacao.dt_inicial BETWEEN '|| quote_literal(dtInicial) ||' AND '|| quote_literal(dtFinal) ||'

				INNER JOIN pessoal'|| stEntidade ||'.contrato_servidor
						ON contrato_servidor.cod_contrato = pensionista.cod_contrato_cedente

				INNER JOIN pessoal'|| stEntidade ||'.servidor_contrato_servidor
						ON servidor_contrato_servidor.cod_contrato = pensionista.cod_contrato_cedente

				INNER JOIN pessoal'|| stEntidade ||'.cargo
						ON contrato_servidor.cod_cargo = cargo.cod_cargo
						
				LEFT JOIN pessoal'|| stEntidade ||'.cbo_cargo
						ON cargo.cod_cargo = cbo_cargo.cod_cargo

				INNER JOIN ( SELECT cod_cargo, max(timestamp) as timestamp 
							   FROM pessoal'|| stEntidade ||'.cbo_cargo
							  INNER JOIN ( SELECT dt_inicial,
												  timestampfechamentoperiodomovimentacao(cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||') as timestamp_fechamento_periodo
											 FROM folhapagamento'|| stEntidade ||'.periodo_movimentacao 
										  ) AS max_timestamp_periodo_movimentacao
									  ON max_timestamp_periodo_movimentacao.dt_inicial BETWEEN '|| quote_literal(dtInicial) ||' AND '|| quote_literal(dtFinal) ||'
							  WHERE cbo_cargo.timestamp::VARCHAR <= max_timestamp_periodo_movimentacao.timestamp_fechamento_periodo 
							  GROUP BY cod_cargo) as max_cbo_cargo 
						ON cbo_cargo.cod_cargo = max_cbo_cargo.cod_cargo
					   AND cbo_cargo.timestamp = max_cbo_cargo.timestamp


				INNER JOIN pessoal'|| stEntidade ||'.contrato_pensionista_orgao
						ON contrato.cod_contrato = contrato_pensionista_orgao.cod_contrato
					  

				INNER JOIN ( SELECT cod_contrato, max(timestamp) as timestamp 
							   FROM pessoal'|| stEntidade ||'.contrato_pensionista_orgao
							  INNER JOIN ( SELECT dt_inicial,
												  timestampfechamentoperiodomovimentacao(cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||') as timestamp_fechamento_periodo
											 FROM folhapagamento'|| stEntidade ||'.periodo_movimentacao 
										 ) AS max_timestamp_periodo_movimentacao
									  ON max_timestamp_periodo_movimentacao.dt_inicial BETWEEN '|| quote_literal(dtInicial) ||' AND '|| quote_literal(dtFinal) ||'
							   WHERE contrato_pensionista_orgao.timestamp::VARCHAR <= max_timestamp_periodo_movimentacao.timestamp_fechamento_periodo
							   GROUP BY cod_contrato) as max_contrato_pensionista_orgao 
						ON contrato_pensionista_orgao.cod_contrato = max_contrato_pensionista_orgao.cod_contrato
					  AND contrato_pensionista_orgao.timestamp = max_contrato_pensionista_orgao.timestamp
						
				INNER JOIN organograma.orgao
						ON contrato_pensionista_orgao.cod_orgao = orgao.cod_orgao

				LEFT JOIN (  SELECT cod_contrato, cod_previdencia, max(timestamp) as timestamp 
							   FROM pessoal'|| stEntidade ||'.contrato_pensionista_previdencia
							  INNER JOIN ( SELECT dt_inicial,
												  timestampfechamentoperiodomovimentacao(cod_periodo_movimentacao, '|| quote_literal(stEntidade) ||') as timestamp_fechamento_periodo
											 FROM folhapagamento'|| stEntidade ||'.periodo_movimentacao 
										  ) AS max_timestamp_periodo_movimentacao
									  ON max_timestamp_periodo_movimentacao.dt_inicial BETWEEN '|| quote_literal(dtInicial) ||' AND '|| quote_literal(dtFinal) ||'
							  WHERE contrato_pensionista_previdencia.timestamp::VARCHAR <= max_timestamp_periodo_movimentacao.timestamp_fechamento_periodo
							  GROUP BY cod_contrato, cod_previdencia) as contrato_pensionista_previdencia 
					   ON contrato.cod_contrato = contrato_pensionista_previdencia.cod_contrato	
            )
	)  ORDER BY dt_inicial, nome, cod_registro_funcionario ';

  FOR reRegistro IN EXECUTE stSql
     LOOP
       RETURN NEXT reRegistro;
     END LOOP;	

  RETURN;
END;
$$LANGUAGE plpgsql;
